---
title: "Seasonal community structure of benthic fish and invertebrates in two nearshore areas of British Columbia"
author: "Hackett, B.1, Rooper, C. N.2*, Boldt, J. L.2, Dealy, L.2, Hodes, V.2 (order TBD)"
format: docx
editor: visual
---

```{r setup,echo=FALSE,warning=FALSE,message=FALSE,results='hide'}
library(rio)
library(ggplot2)
library(lubridate)
library(dplyr)
library(magrittr)
library(tidyr)
library(Hmisc)
library(devtools)
library(stringr)
library(ggmap)
library(maps)
library(mapdata)
library(cluster)
library(MASS)
library(corrplot)
library(gridExtra)
library(vegan)
library(dendextend)
library(ggalt)
library(raster)
library(indicspecies)
library(rgeos)
library(rgdal)
library(maps)
library(perm)
library(rasterVis)
library(sf)
library(ggspatial)
library(flextable)
library(officer)

#library(RAM)
options(scipen = 999)



month_colours <- c("Feb"='#e6194B', "Oct"='#3cb44b', "Mar"='#ffe119', "Apr"='#4363d8', 
                   "May"='#f58231', "Jul"='#42d4f4', "Jun"='#f032e6', "Sep"='#fabed4', 
                   "Dec"='#dcbeff', "Nov"='#800000', "Jan"='#aaffc3')

season_colours <- c('Winter'="blue",
                    'Spring'="orange",
                    'Summer'="red",
                    'Fall'="green")

area_colours <- c('A1'="blue",
                    'A2'="orange",
                    'A3'="red",
                    'A4'="green")

north_south_colours<- c("1"="green", "8"="blue")

mycolour <- c( "#000000","#80FFFF","#FF0000" , "#008000", "#808000", "#FF8000",
               "#000080" , "#80FF00", "#FFFF00",'#dcbeff', "#800080", "#FF0080",
               "#008080", "#808080", "#FF8080",'#9A6324',"#80FF80", "#FFFF80",
               "#0000FF", "#8000FF", "#FF00FF", "#0080FF","#8080FF", "#FF80FF",
               "#00FFFF", "#800000")

#===========================================

```

1 Department of Environmental Sciences, University of Victoria, 2 Pacific Biological Station, Fisheries and Oceans Canada, 3190 Hammond Bay Road, Nanaimo, British Columbia, V9T 6N7, Canada \* Corresponding author: Chris.Rooper\@dfo-mpo.gc.ca

Key words: Community structure, nearshore fishes, multivariate analysis, fish assemblage, biodiversity

\newpage

# Abstract:

# Introduction
         
Nearshore and inshore marine areas are important habitats for a diverse array of fishes. These can include commercially important fishes in all life history stages (references), as well as species that are not commercially important, but may have important ecological roles in the nearshore (references). Nearshore areas are increasingly utilized, not only for their capacity to produce consumable fish biomass, but for other human uses, such as energy development (references). In addition, temperate nearshore systems are likely to be impacted by the effects of climate change in the relatively near future (references).  Defining seasonal patterns in fish communities will contribute to our ability to assess changes in nearshore fish communities and manage responses to both the observed changes and potential new threats.

The nearshore and inshore marine waters of British Columbia are important ecosystems, historically supporting harvests of fish by First Nations, and commercial and recreational fisheries (reference). Benthic species such as Pacific halibut and shrimps are harvested by all three types of fisheries, while other common species such as skates, sharks, forage fishes and ratfish are not widely utilized, but play important roles in the ecosystem. In addition, there are a few species, such as eulachon which are listed as threatened due to historical declines in abundance (reference). The relationships and interconnected-ness among these and the other species that inhabit nearshore and inshore marine waters in British Columbia are relatively unknown and unexplored. However, changes in the structure of nearshore fish communities can have broad implications for human use, as well as implications for the food webs and predator-prey relationships among the fish and invertebrate communities in this region. 

To date, most of the information on nearshore fishes and invertebrates in British Columbia has been collected during summertime bottom-trawl surveys (references) meant to support stock assessment for commercially important species such as shrimps (references). Summertime tends to be the most common time for data collection in other systems as well (references). It is unclear if there are seasonal patterns in the structure of these ecosystems or whether the structure varies with changing oceanographic conditions caused by the highly variable seasonal changes that happen in the nearshore. It is also unclear if there are spatial patterns in nearshore assemblages that are consistent over seasonality and how much variability is present within an area of the coast relative to a larger coastwide region. The objectives of this study were to examine the seasonal and spatial structure of benthic fish and invertebrate communities in two areas of British Columbia. We compared the diversity of the catch among seasons and areas, clustered the communities by their similarity in species composition and catch, and examined the main environmental gradients (depth, temperature and salinity as determined by ROMS model output) that appeared to structure the communities. Additional goals were to identify indicator species for each of the communities and define the important gradients of change through multivariate analyses.

# Methods

## Study areas

The original goal of this survey was to estimate the seasonal abundance of eulachon (Thaleichthys pacificus) returning to river systems in northern British Columbia and the Fraser River in southern British Columbia, thus four areas were chosen for the study; Chatham Sound, the Strait of Juan de Fuca, Haro Strait and the southern Strait of Georgia (Figure 1). The Chatham Sound area is located on the northern coast of British Columbia (Figure 1). It was chosen based on its proximity to two large rivers (the Nass and Skeena rivers) that support significant eulachon runs (Hay et al. 1997). The Chatham Sound area is protected from the open ocean by a series of large and small islands. The area is approximately 25 km from east to west and 50 km from north to south. The Strait of Juan de Fuca area was between the tip of Washington state (U.S.A.) between Swiftsure Bank and Race Rocks at the southernmost tip of Vancouver Island in Canadian waters. This area was about 60 km by 10 km. The Haro Strait area was from Race Rocks to the mid-point of Galiano Island and the Strait of Georgia area was considered as the region between the mid-point of Galiano Island and Howe Sound north of the Fraser River mouth (Figure 1). These two areas were chosen because of their proximity and position as a migration corridor for eulachon returning to spawn in the Fraser River (Hay et al. 1997).

```{r import data sets, echo=FALSE, warning=FALSE, message=FALSE}

taxa.data <- import("C:\\Users\\rooperc\\Desktop\\Eulachon\\EulachonMultivariateAnalysis\\eulachon\\TaxaGroups.csv")

catch.data <- import("C:\\Users\\rooperc\\Desktop\\Eulachon\\EulachonMultivariateAnalysis\\eulachon\\catch.csv")

temp.data <- import("C:\\Users\\rooperc\\Desktop\\Eulachon\\EulachonMultivariateAnalysis\\eulachon\\temperature.csv")

area.data <- import("C:\\Users\\rooperc\\Desktop\\Eulachon\\EulachonMultivariateAnalysis\\eulachon\\areasforBrooke.csv")

#Correct a few bad areas
area.data$AreaGrouping[area.data$FISHING_EVENT_ID==4538891|area.data$FISHING_EVENT_ID==4536324|area.data$FISHING_EVENT_ID==4536269|area.data$FISHING_EVENT_ID==4536312|area.data$FISHING_EVENT_ID==4538390]<-"A2"
area.data$AreaGrouping[area.data$FISHING_EVENT_ID==4536271|area.data$FISHING_EVENT_ID==4536308]<-"A1"
area.data$AreaGrouping[area.data$FISHING_EVENT_ID==4538377|area.data$FISHING_EVENT_ID==4538876]<-"A3"
area.data$AreaGrouping[area.data$FISHING_EVENT_ID==4538366]<-"A1"

# merge data sets
area_catch_data <- merge(catch.data, area.data, by.x = "EVENT_ID",by.y="FISHING_EVENT_ID", all = TRUE)

area_taxa_catch_data <- merge(area_catch_data, taxa.data, by = "Species_name")

area_taxa_catch_temp_data <- merge( area_taxa_catch_data, temp.data, by = c("TRIP_ID", "EVENT_ID"))

# ggplot(area_catch_data[area_catch_data$AreaGrouping=="A2",])+geom_label(aes(x=START_LONGITUDE,y=START_LATITUDE,label=EVENT_ID))
# t1<-subset(area_catch_data,area_catch_data$START_LONGITUDE<(-123)&area_catch_data$AreaGrouping=="A2")
# unique(t1$EVENT_ID)

# Changing NAs in AreaGrouping from the north survey to A4
area_taxa_catch_temp_data$AreaGrouping <- replace_na(area_taxa_catch_temp_data$AreaGrouping, "A4")

# reorder data frame
catch_data <- area_taxa_catch_temp_data %>%
  dplyr::select(Species_name, TRIP_ID,EVENT_ID, SET_ID, YEAR, MONTH, DATE, 
                MAJOR_STAT_AREA_CODE, AreaGrouping, START_LATITUDE, START_LONGITUDE,
                END_LATITUDE, END_LONGITUDE, DEPTH, MEAN_TEMPERATURE, 
                CPUE, Taxonomic_group) %>%
  arrange(., Species_name)


# manipulate date variables with lubridate

catch_data$DATE <- ymd(catch_data$DATE)

catch_data$MONTH <- month(catch_data$DATE, label = TRUE, abbr = TRUE)

catch_data$YEAR <- year(catch_data$DATE)

# adding season to data set

catch_data <- catch_data %>% 
  mutate(., SEASON = recode(catch_data$MONTH, 
                            "Jan" = "Winter",
                            "Feb"="Winter",
                            "Mar"="Spring",
                            "Apr"="Spring",
                            "May"="Spring",
                            "Jun"="Summer",
                            "Jul"="Summer",
                            "Aug"="Summer",
                            "Sep"="Fall",
                            "Oct"="Fall",
                            "Nov"="Fall",
                            "Dec"="Winter"), .after=DATE)


# change taxonomic group and species names to factors 

catch_data$Taxonomic_group <- factor(catch_data$Taxonomic_group)

catch_data$Species_name <- factor(catch_data$Species_name)


# adding top 25 species common name to dataset

catch_data <- catch_data %>% 
  mutate(., Species_common_name = recode(catch_data$Species_name,
                                         "ACTINIARIA"="Sea anemone",
                                         "ANOPLOPOMA.FIMBRIA"="Sablefish",
                                         "ATHERESTHES.STOMIAS"= "Arrowtooth flounder",
                                         "BATHYRAJA.INTERRUPTA"="Bering skate",
                                         "BERINGRAJA.BINOCULATA"="Big skate",
                                         "CLUPEA.PALLASII"= "Pacific herring",
                                         "GADUS.CHALCOGRAMMUS"="Walleye pollock",
                                         "GADUS.MACROCEPHALUS"="Pacific cod",
                                         "GLYPTOCEPHALUS.ZACHIRUS"="Rex sole",
                                         "HIPPOGLOSSOIDES.ELASSODON"="Flathead sole",
                                         "HYDROLAGUS.COLLIEI"="Spotted ratfish",
                                         "LYCODES.BREVIPES"="Shortfin eelpout",
                                         "LYCODES.PACIFICUS"="Blackbelly eelpout",
                                         "LYOPSETTA.EXILIS"="Slender soles",
                                         "MERLUCCIUS.PRODUCTUS"="North pacific hake",
                                         "MICROSTOMUS.PACIFICUS"="Pacific dover sole",
                                         "PANDALOPSIS.DISPAR"="Sidestripe shrimp",
                                         "PANDALUS.BOREALIS"="Northern shrimp",
                                         "PANDALUS.JORDANI"="Pink shrimp",
                                         "PANDALUS.PLATYCEROS"="Spot prawn",
                                         "PAROPHRYS.VETULUS"="English sole",
                                         "PECTINIDAE"="Scallop",
                                         "RAJA.RHINA"="Longnose skate",
                                         "SQUALUS.SUCKLEYI"="Pacific spiny dogfish",
                                         "THALEICHTHYS.PACIFICUS"="Eulachon"),
                                          .after=Species_name)

# changing top 25 species name format

catch_data$Species_name <- recode_factor(catch_data$Species_name, 
                                                      "ACTINIARIA"="Actiniaria",
                                                      "ANOPLOPOMA.FIMBRIA"="Anoplopoma fimbria",
                                                      "ATHERESTHES.STOMIAS"= "Atheresthes stomias",
                                                      "BATHYRAJA.INTERRUPTA"="Bathyraja interrupta",
                                                      "BERINGRAJA.BINOCULATA"="Beringraja binoculata",
                                                      "CLUPEA.PALLASII"= "Clupea pallasii",
                                                      "GADUS.CHALCOGRAMMUS"="Gadus chalcogrammus",
                                                      "GADUS.MACROCEPHALUS"="Gadus macrocephalus",
                                                      "GLYPTOCEPHALUS.ZACHIRUS"="Glyptocephalus zachirus",
                                                      "HIPPOGLOSSOIDES.ELASSODON"="Hippoglossoides elassodon",
                                                      "HYDROLAGUS.COLLIEI"="Hydrolagus colliei",
                                                      "LYCODES.BREVIPES"="Lycodes brevipes",
                                                      "LYCODES.PACIFICUS"="Lycodes pacificus",
                                                      "LYOPSETTA.EXILIS"="Lyopsetta exilis",
                                                      "MERLUCCIUS.PRODUCTUS"="Merluccius productus",
                                                      "MICROSTOMUS.PACIFICUS"="Microstomus pacificus",
                                                      "PANDALOPSIS.DISPAR"="Pandalopsis dispar",
                                                      "PANDALUS.BOREALIS"="Pandalus borealis",
                                                      "PANDALUS.JORDANI"="Pandalus jordani",
                                                      "PANDALUS.PLATYCEROS"="Pandalus Platyceros",
                                                      "PAROPHRYS.VETULUS"="Parophrys vetulus",
                                                      "PECTINIDAE"="Pectinidae",
                                                      "RAJA.RHINA"="Raja rhina",
                                                      "SQUALUS.SUCKLEYI"="Squalus suckleyi",
                                                      "THALEICHTHYS.PACIFICUS"="Thaleichthys pacificus")


# remove irrelevant taxa groups and tows from Hecate Strait and sets with only Eulachon CPUE recorded

catch_data <- catch_data %>%
  filter(., Taxonomic_group %nin% c("Marine mammal",
                                    "Other",
                                    "Euphausid",
                                    "Worm",
                                    "Isopod"),
         EVENT_ID %nin% c(4363856,
                          4363858,
                          4564096,
                          4564094,
                          4363883))

# factor species name, taxonomic group again to get rid of extra levels that were filtered out
# factor MAJOR_STAT_AREA_CODE

catch_data$Taxonomic_group <- factor(catch_data$Taxonomic_group)

catch_data$Species_name <- factor(catch_data$Species_name)

catch_data$MAJOR_STAT_AREA_CODE <- factor(catch_data$MAJOR_STAT_AREA_CODE)

catch_data$AreaName[catch_data$AreaGrouping=="A1"]<-"Strait of Juan de Fuca"
catch_data$AreaName[catch_data$AreaGrouping=="A2"]<-"Haro Strait"
catch_data$AreaName[catch_data$AreaGrouping=="A3"]<-"Strait of Georgia"
catch_data$AreaName[catch_data$AreaGrouping=="A4"]<-"Chatham Sound"

# creating data table in wide format

catch_wide <- pivot_wider(catch_data,
                          names_from =Species_common_name,
                          values_from = CPUE,
                          id_cols = !c(Taxonomic_group,Species_name))


#Define top 25 species
t1<-aggregate(CPUE~Species_name,data=catch_data,FUN="mean")
t1<-t1[order(t1$CPUE,decreasing=TRUE),]
#t1[1:25,]
propcpueLT40<-1-sum(t1$CPUE[1:25])/sum(t1$CPUE)

t1<-aggregate(CPUE~Taxonomic_group,data=catch_data,FUN="sum")
propcpueFish<-t1$CPUE[t1$Taxonomic_group=="Fish"]/sum(t1$CPUE)

# Remove species with mean CPUE < 40

catch_wide_1 <- catch_wide %>%
  dplyr::select(TRIP_ID:MEAN_TEMPERATURE)      

catch_wide_2 <- catch_wide[17:220] %>%
  dplyr::select(where(~ is.numeric(.x) && mean(.x) > 40))

catch_wide_top25 <- cbind(catch_wide_1, catch_wide_2)

# log (CPUE + 1/2 minimum positive value) transform wide data

catch_wide_log <- catch_wide_top25

for (i in 16:40) {
  catch_wide_log[,i]<-log(catch_wide_log[,i]+min(catch_wide_log[catch_wide_log[,i]>0,i])*.5)
}
```

```{r MakeFigure 1,echo=FALSE,warning=FALSE,message=FALSE,results='hide'}

#IMPORT THE LAND
namerica<-readOGR("C:/Users/rooperc/Documents/Chris Work Stuff/R Software Help and Functions/RSpatialWorkshop - Seamount SDM/NorthAmerica Shapefile","namerica_dcw")
namerica<-spTransform(namerica,CRS("+proj=longlat +datum=WGS84"))
namerica2<-st_as_sf(namerica)

 land <- st_read("C:/Users/rooperc/Documents/Chris Work Stuff/R Software Help and Functions/RSpatialWorkshop - Seamount SDM/NorthAmerica Shapefile/namerica_dcw.shp")%>%
   st_transform(crs = 4326)


trawl_location <- catch_data %>%
  group_by(., EVENT_ID)%>%
  summarise(., MONTH=MONTH,
            START_LATITUDE=START_LATITUDE,
            START_LONGITUDE=START_LONGITUDE,
            MAJOR_STAT_AREA_CODE=MAJOR_STAT_AREA_CODE,
            AreaGrouping=AreaGrouping)

trawl_location <- distinct(trawl_location)

#MAKE THE BASE RASTER FOR THE MAP
extent_sr<-extent(min(trawl_location$START_LONGITUDE),max(trawl_location$START_LONGITUDE),min(trawl_location$START_LATITUDE),max(trawl_location$START_LATITUDE))
extent_sr
scratch_raster<-raster(extent_sr,resolution=1,crs=CRS("+proj=longlat +datum=WGS84"))
scratch_raster
values(scratch_raster)<-1
scratch_raster
#plot(scratch_raster)

#MAKE AN INSET POLYGON SHOWING ONLY HAIDA GWAII
SVI.x<-c(-125,-125,-121.75,-121.75,-125)
SVI.y<-c(48,49.5,49.5,48,48)
SVI<-SpatialPolygons(list(Polygons(list(Polygon(cbind(SVI.x,SVI.y))),"SVI")),proj4string=CRS("+proj=longlat +datum=WGS84"))

NC.x<-c(-131.5,-131.5,-129.65,-129.65,-131.5) 
NC.y<-c(53.75,55,55,53.75,53.75)
NC<-SpatialPolygons(list(Polygons(list(Polygon(cbind(NC.x,NC.y))),"NC")),proj4string=CRS("+proj=longlat +datum=WGS84"))

#MAKE THE BIG INSET POLYGON
inset_poly<-rasterToPolygons(scratch_raster,dissolve=TRUE)

legend1<-data.frame(Area=c("Chatham Sound","Strait of Juan de Fuca","Haro Strait","Strait of Georgia"),col1=c("darkred","purple","darkgreen","coral"),x=rep(-132,4),y=c(48,47.5,47,46.5))

#PLOT IT 
#BASE MAP
g1<-gplot(scratch_raster)+
  geom_tile(aes(fill=value),color="transparent",alpha=0)+geom_polygon(data=namerica,aes(x=long,y=lat,group=group,fill=id),fill="grey80",color="grey30")+   
 # annotation_scale(location = "bl", height = unit(.75, "cm"), text_cex = 1.75) +coord_sf(crs=4326)+
  geom_polygon(data=NC,aes(x=long,y=lat),fill="transparent",color="orange")+
  geom_polygon(data=SVI,aes(x=long,y=lat),fill="transparent",color="blue")+

  theme(panel.background=element_rect(fill="white",color="black"),legend.position="none") +xlab("Longitude")+ylab("Latitude")+coord_cartesian(xlim = c(-155,-122.5), ylim = c(46.5,58.25))+annotate("text", x = -125,y=53,angle=-55,size=6, label = "British Columbia")+
  annotate("text", x = -127,y=49.5,angle=-45,size=4, label = "Vancouver Island")+
  annotate("text", x = -133, y=53,angle=-65,size=4, label = "Haida Gwaii")+
  geom_text(data=legend1,aes(x=x,y=y,label=Area,hjust="left"),size=4,label.size=0,nudge_x=.5)+
   geom_point(data=legend1,aes(x=x,y=y),col=legend1$col1)+
    annotation_north_arrow(location = "br", width = unit(.5, "cm"),
                           height = unit(1., "cm"),
                           style = north_arrow_orienteering(
                             line_width = 1,
                             line_col = "black",
                             fill = c("white", "black"),
                             text_col = "black",
                             text_family = "",
                             text_face = NULL,
                             text_size = 10,
                             text_angle = 0)) 
#+ geom_segment(aes(x = -140, y = 57, xend = -140, yend = 58), arrow = arrow(length = unit(0.3, "cm")),size=2)
#g1


#INSET WITH ALL OF NORTH AMERICA
  g2<-ggplot()+geom_sf(data=land,fill="black")+ geom_polygon(data=inset_poly,aes(x=long,y=lat),fill="transparent",color="grey80")+theme(panel.background=element_rect(fill="white",color="black"),axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank())+xlim(c(-170,-50))+ylim(c(0,80))
#MAKE IT A GROB
g2<-ggplotGrob(g2)

g3<-ggplot()+geom_sf(data=land,fill="grey80",color="grey30")+
  geom_polygon(data=NC,aes(x=long,y=lat,group=group),fill="transparent",color="orange",size=2)+
  geom_point(aes(x=trawl_location$START_LONGITUDE[trawl_location$AreaGrouping=="A4"],y=trawl_location$START_LATITUDE[trawl_location$AreaGrouping=="A4"]),color="darkred")+
  xlim(min(NC.x),max(NC.x))+ylim(min(NC.y),max(NC.y))+
  theme(panel.background=element_rect(fill="white",color="black"),axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),legend.position="none")#+ annotate("text", x = -130.85, y=53.40,size=4, label = "Central Coast")
g3<-ggplotGrob(g3)

g4<-ggplot()+geom_sf(data=land,fill="grey80",color="grey30")+
  geom_polygon(data=SVI,aes(x=long,y=lat,group=group),fill="transparent",color="blue",size=2)+
  geom_point(aes(x=trawl_location$START_LONGITUDE[trawl_location$AreaGrouping=="A1"],y=trawl_location$START_LATITUDE[trawl_location$AreaGrouping=="A1"]),color="purple")+
  geom_point(aes(x=trawl_location$START_LONGITUDE[trawl_location$AreaGrouping=="A2"],y=trawl_location$START_LATITUDE[trawl_location$AreaGrouping=="A2"]),color="darkgreen")+
    geom_point(aes(x=trawl_location$START_LONGITUDE[trawl_location$AreaGrouping=="A3"],y=trawl_location$START_LATITUDE[trawl_location$AreaGrouping=="A3"]),color="coral")+
  xlim(min(SVI.x),max(SVI.x))+ylim(min(SVI.y),max(SVI.y))+
  theme(panel.background=element_rect(fill="white",color="black"),axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),legend.position="none")#+annotate("text", x = -123.75, y=48.8,size=3, angle=-40,label = "South Coast")+annotate("text", x = -123.65, y=48.65,size=3, angle=-40,label = "Vancouver Island")
g4<-ggplotGrob(g4)

#PUT IT ALL TOGETHER

g5 <- g1 +
      annotation_custom(grob = g3, xmin = -147, xmax = -137,
                        ymin = 52.5, ymax = 58.75) +
        annotation_custom(grob = g4, xmin = -149, xmax = -133,
                        ymin = 46, ymax = 52.5) +
      annotation_custom(grob = g2, xmin = -128, xmax = -121,
                        ymin = 55.5, ymax = 59)

#MAKE IT A FILE
png("C:/Users/rooperc/Desktop/Eulachon/EulachonMultivariateAnalysis/Manuscript/Figure1.png",width=9,height=6,unit="in",res=300)
print(g5)
dev.off()
```

```{r Table1data,echo=FALSE,warning=FALSE,results='hide',message=FALSE}
#### Number of sets by AreaGrouping
#204 species total so 204 rows for each set
#so number of sets = unique count by MONTH, YEAR, MAJOR_STAT_AREA_CODE(or AreaGrouping)/204

samples_by_month_year_area <- catch_data %>% 
  group_by(., AreaName, MONTH, YEAR) %>%
  summarise(., number_of_sets = n()/204) 

samples_by_month_year_area <-samples_by_month_year_area %>%
  arrange(., AreaName,YEAR)

colnames(samples_by_month_year_area ) <- c("Area","Month", "Year","Total sets")

# in wide format
samples_wide <-pivot_wider(samples_by_month_year_area, 
                           names_from = Area, 
                           values_from = "Total sets")

samples_wide <- samples_wide%>% arrange(., Year)
samples_wide_tots<-sapply(samples_wide[,3:6],FUN="sum",na.rm=TRUE)
samples_wide_tots<-data.frame(Month="Total",Year=NA,'Chatham Sound'=samples_wide_tots[1],"Haro Strait"=samples_wide_tots[2],'Strait of Georgia'=samples_wide_tots[3],'Strait of Juan de Fuca'=samples_wide_tots[4])
names(samples_wide_tots)<-names(samples_wide)
samples_wide<-rbind(samples_wide,samples_wide_tots)

```

## Trawl survey data

```{r Table2data,echo=FALSE,warning=FALSE,message=FALSE,results='hide'}
catch_top25 <- catch_data %>% 
  filter(., Species_common_name %in% c("Sea anemone",
                                       "Sablefish",
                                       "Arrowtooth flounder",
                                       "Bering skate",
                                       "Big skate",
                                       "Pacific herring",
                                       "Walleye pollock",
                                       "Pacific cod",
                                       "Rex sole",
                                       "Flathead sole",
                                       "Spotted ratfish",
                                       "Shortfin eelpout",
                                       "Blackbelly eelpout",
                                       "Slender soles",
                                       "North pacific hake",
                                       "Pacific dover sole",
                                       "Sidestripe shrimp",
                                       "Northern shrimp",
                                       "Pink shrimp",
                                       "Spot prawn",
                                       "English sole",
                                       "Scallop",
                                       "Longnose skate",
                                       "Pacific spiny dogfish",
                                       "Eulachon" ))

# add log CPUE

#catch_top25 <- catch_top25 %>% 
#  mutate(., log_CPUE = log(CPUE+1), .after = CPUE)


# mean CPUE north vs south

mean_CPUE_top25_north_south <- catch_top25 %>%
  group_by(., Species_name, Species_common_name, MAJOR_STAT_AREA_CODE)%>%
  summarise(., mean_CPUE = mean(CPUE))

mean_CPUE_top25_north_south <- pivot_wider(mean_CPUE_top25_north_south, 
                                names_from = MAJOR_STAT_AREA_CODE, 
                                values_from = mean_CPUE)

colnames(mean_CPUE_top25_north_south)<- c("Scientific Name", "Common Name", 
                                          "South CPUE", "North CPUE")

# mean CPUE by area
mean_CPUE_top25_area <- catch_top25 %>%
  group_by(., Species_name, Species_common_name, AreaGrouping)%>%
  summarise(., mean_CPUE = mean(CPUE))

mean_CPUE_top25_area <- pivot_wider(mean_CPUE_top25_area, 
                                           names_from = AreaGrouping, 
                                           values_from = mean_CPUE)

colnames(mean_CPUE_top25_area)<- c("Scientific Name", "Common Name", 
                                          "Strait of Juan de Fuca", "Haro Strait",
                                   "Strait of Georgia", "Chatham Sound")
```
```{r Figure2data,echo=FALSE,message=FALSE,results='hide',warning=FALSE}
### by area 

CPUE_by_month_area <- catch_top25 %>%
  group_by(., Species_common_name, MONTH, AreaGrouping) %>%
  summarise(., mean_CPUE = mean(CPUE),
            total_CPUE = sum(CPUE))

# add row for august to data frame for plotting
aug_row2 <- data.frame(Species_common_name = "Eulachon",
                      MONTH ="Aug", 
                      AreaGrouping = "A1",
                      mean_CPUE= 0, 
                      total_CPUE = 0)

CPUE_by_month_area <- rbind(CPUE_by_month_area, aug_row2)


CPUE_by_month_area$MONTH<-factor(CPUE_by_month_area$MONTH,
                                        levels=c("Jan", "Feb", "Mar", "Apr",
                                                 "May", "Jun", "Jul","Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"))

CPUE_by_month_area$AreaGrouping<-factor(CPUE_by_month_area$AreaGrouping,
                                        labels=c("Strait of Juan de Fuca", "Haro Strait", "Strait of Georgia", "Chatham Sound"))


# mean CPUE by month and area standardized to one  

g5<-ggplot(CPUE_by_month_area )+
  geom_bar(aes(x=MONTH, y=mean_CPUE, fill=Species_common_name), 
           stat = "identity", position = "fill")+
  scale_fill_manual(values = mycolour) +
  facet_wrap(~AreaGrouping)+
  labs(y= "Proportion", x= "Month", fill= "Species" )

png("C:/Users/rooperc/Desktop/Eulachon/EulachonMultivariateAnalysis/Manuscript/Figure2.png",width=9,height=6,unit="in",res=300)
print(g5)
dev.off()


```
Data collection and survey design The surveys were conducted in the four areas (Chatham Sound, Strait of Juan de Fuca, Haro Strait and Strait of Georgia) using the same survey design. Each study area was divided into 2 km by 2 km grid cells at depths of 80 to 300 m. A random sample of grid cells (80 in Chatham Sound, 40 in the Strait of Juan de Fuca, 40 in Haro Strait, and 40 in the Strait of Georgia) was chosen prior to each survey. A subset of these randomly stations was chosen haphazardly to be sampled each day based on the trawlability of the seafloor at the location, the weather conditions and the end location of the previous days fishing (to maximize efficiency and the number of samples collected). At each of the selected blocks a bottom trawl survey tow was conducted. Fishing was only conducted during daylight hours. The bottom trawl fishing was conducted using the CCGS research vessel Neocaligus, using an American shrimp trawl. The shrimp trawl had a net width of 10 to 11 m and the net opening height was 2 to 3 m off the seafloor. The net utilized roller gear and 1.8 m trawl doors. Net mensuration (measuring the mouth opening) was used to determine the time when the trawl doors reached the seafloor and was in fishing configuration. Each bottom trawl tow targeted five minutes of on bottom time in the Chatham Strait area (due to high catch rates of eulachon) and 20 minutes of on bottom time in the other study areas. The beginning and end positions were recorded using an on board GPS unit and these positions and the average net width (10.5 m) were used to estimate the area swept. Auxiliary information on the bottom depth, vessel speed and warp length were collected for each set. Depth and temperature were also collected on 10 second intervals throughout the bottom trawl tow using a Star-Oddi DST centi-TD temperature-depth logger mounted on the headrope of the net. Each bottom trawl catch was sorted by species, or in the case of some larger catches, a random subsample of the catch was taken and the resulting data expanded to account for the total catch. The total weight of each species captured in a bottom trawl tow was measured using a motion-compensated scale. The catch weight was then divided by the area swept in each tow to calculate a catch-per-unit-of-effort (CPUE) for each species collected in the bottom trawl. 

## Data analysis
### Co-occurence and diversity

```{r Figure3data,echo=FALSE,warning=FALSE,message=FALSE,results='hide'}
species_cor <- cor(data.frame(catch_wide_log[,16:40]),use="complete.obs")

png("C:/Users/rooperc/Desktop/Eulachon/EulachonMultivariateAnalysis/Manuscript/Figure3.png",width=7,height=7,units="in",res=300)
corrplot(species_cor, tl.col = "black", tl.cex = 0.75,type="lower",method="color",outline=FALSE,diag=FALSE,order="FPC",mar=c(0,0,0,0),tl.srt=35)
dev.off()
```

Table 4. Diversity measures by month and area 

```{r table4data,echo=FALSE,results='hide',warning=FALSE,message=FALSE}

diversity_data <- catch_data %>% 
  mutate(., MONTH_YEAR = format(as.Date(catch_data$DATE,format="%Y-%m-%d")
                                ,"%b-%y"), .after = MONTH)


diversity_data <- diversity_data %>% group_by(., MONTH, AreaName,SEASON, EVENT_ID, Species_name) %>%
  summarise(mean_CPUE = mean(CPUE))

diversity_data<- pivot_wider(diversity_data, names_from = Species_name, 
                             values_from = mean_CPUE)

# calculate diversity index
diversity_data$Simpson <- diversity(diversity_data[,5:208], "simpson")
diversity_data$Shannon <- diversity(diversity_data[,5:208], "shannon")

H <- diversity(diversity_data[,5:208])
diversity_data$Evenness <- H/log(specnumber(diversity_data[,5:208]))

diversity_data$Richness<-specnumber(diversity_data[,5:208])

richness_aov<-aov(Richness~AreaName+SEASON+AreaName*SEASON,data=diversity_data)
# richness_aov
# summary(richness_aov)
# TukeyHSD(richness_aov,which='AreaName:SEASON')
# TukeyHSD(richness_aov,which='AreaName')
# TukeyHSD(richness_aov,which='SEASON')
# boxplot(Richness~AreaName+SEASON,data=diversity_data)

Simpson_aov<-aov(Simpson~AreaName+SEASON+AreaName*SEASON,data=diversity_data)
# Simpson_aov
# summary(Simpson_aov)
# TukeyHSD(Simpson_aov,which='AreaName')
# TukeyHSD(Simpson_aov,which='SEASON')
# boxplot(Simpson~AreaName+SEASON,data=diversity_data)
# 
Shannon_aov<-aov(Shannon~AreaName+SEASON+AreaName*SEASON,data=diversity_data)
# Shannon_aov
# summary(Shannon_aov)
# TukeyHSD(Shannon_aov,which='AreaName:SEASON')
# boxplot(Shannon~AreaName+SEASON,data=diversity_data)

Evenness_aov<-aov(Evenness~AreaName+SEASON+AreaName*SEASON,data=diversity_data)
# Evenness_aov
# summary(Evenness_aov)
# TukeyHSD(Evenness_aov,which='AreaName')
# TukeyHSD(Evenness_aov,which='SEASON')
# boxplot(Evenness~AreaName+SEASON,data=diversity_data)

divplot <- data.frame(Season=diversity_data$SEASON,Area=diversity_data$AreaName,Shannon=diversity_data$Shannon, Simpson=diversity_data$Simpson, Evenness=diversity_data$Evenness,Richness=diversity_data$Richness)
divplot<-pivot_longer(divplot,cols=Shannon:Richness,names_to="Index",values_to="Value")
 #                             row.names = diversity_data_rowname)
g1<-ggplot(divplot)+geom_boxplot(aes(x=Season,y=Value,fill=Area))
png("C:/Users/rooperc/Desktop/Eulachon/EulachonMultivariateAnalysis/Manuscript/Figure4.png",width=9,height=6,units="in",res=300)
g1+facet_wrap(~Index,ncol=2,scales="free_y")
dev.off()

```

Statistical analysis Comparisons of diversity were made between areas and seasons within study areas. Four diversity measures were examined using the full data set (including all species); species richness (the total number of species captured), the Shannon-Weiner diversity index, the Simpson index and Pielou's species evenness (using CPUE for each species). Comparisons were made using analysis of variance (ANOVA), where area, season and an interaction term between area and season were the independent factors. Pairwise comparisons were made for significant terms in the ANOVA using Tukey's post-hoc test. Significance was judged at a p \< 0.05. 

### Multivariate and cluster analyses

```{r Figure5data}
####### Cluster by trip #######

# cluster analysis of top 25 species abundance across the 17 trips using the average 
# CPUE across all hauls of a cruise pooled together

# adding year month values to dataset 

cluster_top25 <- catch_top25 %>% 
  mutate(., MONTH_YEAR = format(as.Date(catch_top25$DATE,format="%Y-%m-%d")
                                ,"%b-%y"), .after = MONTH)
temp1<-aggregate(CPUE~Species_name,data=cluster_top25[cluster_top25$CPUE>0,],FUN="min")
cluster_top25$log_CPUE<-NA
for(i in 1:dim(temp1)[1]){
cluster_top25$log_CPUE[cluster_top25$Species_name==temp1$Species_name[i]]<-log(cluster_top25$CPUE[cluster_top25$Species_name==temp1$Species_name[i]]+temp1$CPUE[i]*.5)
}
cluster_top25$log_CPUE<-log(cluster_top25$CPUE+1)
mean_top25_log <- cluster_top25 %>% 
  group_by(., TRIP_ID, MAJOR_STAT_AREA_CODE, Species_common_name, SEASON) %>%
  summarise(., mean_log_CPUE = mean(log_CPUE))

mean_top25_log <- mean_top25_log %>% 
  pivot_wider(., names_from = Species_common_name, values_from = mean_log_CPUE) 


# use trip ID as row names 

mean_top25_log <- as.data.frame(mean_top25_log, row.names = mean_top25_log$TRIP_ID)
mean_top25_log <- as.data.frame(mean_top25_log, row.names = mean_top25_log$TRIP_ID)

trip_cluster_data <- mean_top25_log[,-c(1:3)]

# Hierarchical clustering by trip

apply(trip_cluster_data, 1, sum)

##### scale to 1? not done in other papers
# Turn CPUE to relative abundance by dividing each value by sample total abundance

#trip_cluster_data <- decostand(trip_cluster_data, method = "total")

# check total abundance in each sample

#apply(trip_cluster_data, 1, sum)


# calculate Bray-Curtis distance among samples

trip_dist <- vegdist(trip_cluster_data, method = "bray")

# cluster communities using average-linkage algorithm
trip_cluster <- hclust(trip_dist, method = "ward.D2")

# plot cluster diagram
plot(trip_cluster, ylab = "Bray-Curtis dissimilarity")

# cluster diagram coloured by area

trip_dend <- as.dendrogram(hclust(trip_dist, method = "ward.D2"))

order.dendrogram(trip_dend)

labels_colors(trip_dend)<-north_south_colours[mean_top25_log$MAJOR_STAT_AREA_CODE][order.dendrogram(trip_dend)]

plot(hang.dendrogram(trip_dend, hang = 0.1), ylab = "Bray-Curtis dissimilarity", main = "Cluster Dendrogram")
legend("topright", legend=c("North", "South"), title= "Area", pch=19, 
       col=c("blue", "green"))



######### Cluster by trip using date #######

mean_top25_log_date <- cluster_top25 %>% 
  group_by(., MONTH_YEAR, MAJOR_STAT_AREA_CODE, Species_common_name) %>%
  summarise(., mean_log_CPUE = mean(log_CPUE))

mean_top25_log_date <- mean_top25_log_date %>% 
  pivot_wider(., names_from = Species_common_name, values_from = mean_log_CPUE) 

# use trip ID as row names 

mean_top25_log_date <- as.data.frame(mean_top25_log_date, row.names = mean_top25_log_date$MONTH_YEAR)
mean_top25_log_date <- as.data.frame(mean_top25_log_date, row.names = mean_top25_log_date$MONTH_YEAR)

date_cluster_data <- mean_top25_log_date[,-c(1:2)]

#Hierarchical clustering 

apply(date_cluster_data, 1, sum)

# Turn CPUE to relative abundance by dividing each value by sample total abundance

#date_cluster_data <- decostand(date_cluster_data, method = "total")

# check total abundance in each sample

#apply(date_cluster_data, 1, sum)

# calculate Bray-Curtis distance among samples

date_dist <- vegdist(date_cluster_data, method = "bray")

# cluster communities using average-linkage algorithm
date_cluster <- hclust(date_dist, method = "average")

# plot cluster diagram
plot(date_cluster, ylab = "Bray-Curtis dissimilarity")

# cluster diagram coloured by area

date_dend <- as.dendrogram(hclust(date_dist, method = "average"))

order.dendrogram(date_dend)

labels_colors(date_dend)<-north_south_colours[mean_top25_log_date$MAJOR_STAT_AREA_CODE][order.dendrogram(date_dend)]

plot(hang.dendrogram(date_dend, hang = 0.1), ylab = "Bray-Curtis dissimilarity", main = "Cluster Dendrogram")
legend("topright", legend=c("North", "South"), title= "Area", pch=19, 
       col=c("blue", "green"))


####### Cluster by event and area #######

species_cluster_matrix_area <- catch_wide_log[,-c(1,3:15)]

cluster_groups <-  catch_wide_log[,c(2,9)]

# use event ID as row names 

species_cluster_matrix <- as.data.frame(species_cluster_matrix_area, 
                                        row.names = species_cluster_matrix_area$EVENT_ID)
species_cluster_matrix <- as.data.frame(species_cluster_matrix, 
                                        row.names = species_cluster_matrix$EVENT_ID)

species_cluster_matrix <- species_cluster_matrix[,-1]


# calculate Bray-Curtis distance among samples

event_dist <- vegdist(species_cluster_matrix, method = "bray")

# cluster communities using average-linkage algorithm
event_cluster <- hclust(event_dist, method = "average")

# plot cluster diagram
plot(event_cluster, ylab = "Bray-Curtis dissimilarity")

# cluster diagram coloured by area

event_dend <- as.dendrogram(hclust(event_dist, method = "average"))

order.dendrogram(event_dend)

labels_colors(event_dend)<-area_colours[catch_wide_log$AreaGrouping][order.dendrogram(event_dend)]

plot(hang.dendrogram(event_dend), ylab = "Bray-Curtis dissimilarity",
     main = "Cluster Dendrogram")
legend("topright", legend=c("A1", "A2","A3","A4"), title= "Area", pch=19, 
       col=area_colours)


####### Cluster by trip and area #######

# cluster analysis of top 25 species abundance across the 17 trips using the average 
# CPUE across all hauls of a cruise pooled together

mean_top25_log_area <- cluster_top25 %>% 
  group_by(., TRIP_ID, AreaGrouping, Species_common_name) %>%
  summarise(., mean_log_CPUE = mean(log_CPUE))

mean_top25_log_area <- mean_top25_log_area %>% 
  pivot_wider(., names_from = Species_common_name, values_from = mean_log_CPUE) 


# use trip ID as row names 

mean_top25_log_area <- as.data.frame(mean_top25_log_area, 
                                     row.names = mean_top25_log_area$TRIP_ID)
mean_top25_log_area <- as.data.frame(mean_top25_log_area, 
                                     row.names = mean_top25_log_area$TRIP_ID)

area_cluster_data <- mean_top25_log_area[,-c(1:2)]

# Hierarchical clustering by trip

apply(area_cluster_data, 1, sum)

##### scale to 1? not done in other papers
# Turn CPUE to relative abundance by dividing each value by sample total abundance

#trip_cluster_data <- decostand(trip_cluster_data, method = "total")

# check total abundance in each sample

#apply(trip_cluster_data, 1, sum)


# calculate Bray-Curtis distance among samples

area_dist <- vegdist(area_cluster_data, method = "bray")

# cluster communities using average-linkage algorithm
area_cluster <- hclust(area_dist, method = "average")

# plot cluster diagram
plot(area_cluster, ylab = "Bray-Curtis dissimilarity")

# cluster diagram coloured by area

area_dend <- as.dendrogram(hclust(area_dist, method = "average"))

order.dendrogram(area_dend)

labels_colors(area_dend)<-area_colours[mean_top25_log_area$AreaGrouping][order.dendrogram(area_dend)]

plot(hang.dendrogram(area_dend, hang = 0.1), ylab = "Bray-Curtis dissimilarity", main = "Cluster Dendrogram")
legend("topright", legend=c("A1", "A2","A3","A4"), title= "Area", pch=19, 
       col=area_colours)

######### Cluster by trip and area using date #######

mean_top25_log_date_area <- cluster_top25 %>% 
  group_by(., MONTH_YEAR, AreaGrouping, Species_common_name) %>%
  summarise(., mean_log_CPUE = mean(log_CPUE))

mean_top25_log_date_area <- mean_top25_log_date_area %>% 
  pivot_wider(., names_from = Species_common_name, values_from = mean_log_CPUE) 

# use trip ID as row names 

mean_top25_log_date_area <- as.data.frame(mean_top25_log_date_area, 
                                          row.names = mean_top25_log_date_area$MONTH_YEAR)
mean_top25_log_date_area <- as.data.frame(mean_top25_log_date_area, 
                                          row.names = mean_top25_log_date_area$MONTH_YEAR)

date_area_cluster_data <- mean_top25_log_date_area[,-c(1:2)]

#Hierarchical clustering 

apply(date_area_cluster_data, 1, sum)

# Turn CPUE to relative abundance by dividing each value by sample total abundance

#date_cluster_data <- decostand(date_cluster_data, method = "total")

# check total abundance in each sample

#apply(date_cluster_data, 1, sum)

# calculate Bray-Curtis distance among samples

date_area_dist <- vegdist(date_area_cluster_data, method = "bray")

# cluster communities using average-linkage algorithm
date_area_cluster <- hclust(date_area_dist, method = "average")

# plot cluster diagram
plot(date_area_cluster, ylab = "Bray-Curtis dissimilarity")

# cluster diagram coloured by area

date_area_dend <- as.dendrogram(hclust(date_area_dist, method = "average"))

order.dendrogram(date_area_dend)

labels_colors(date_area_dend)<-area_colours[mean_top25_log_date_area$AreaGrouping][order.dendrogram(date_area_dend)]

plot(hang.dendrogram(date_area_dend, hang = 0.1), ylab = "Bray-Curtis dissimilarity", main = "Cluster Dendrogram")
legend("topright", legend=c("A1", "A2","A3","A4"), title= "Area", pch=19, 
       col=area_colours)


######### Cluster by species #######

# cluster analysis of top 25 species CPUE across all events/halls 
# to examine which species had similar distributions among the hauls

# filter event id and species CPUE

species_cluster_data <- catch_wide_log[,-c(1,3:15)]

# use event ID as row names 

species_cluster_data <- as.data.frame(species_cluster_data, row.names = species_cluster_data$EVENT_ID)
species_cluster_data <- as.data.frame(species_cluster_data, row.names = species_cluster_data$EVENT_ID)

species_cluster_data <- species_cluster_data[,-1]

# transpose matrix 

species_cluster_data <- t(species_cluster_data)



####### Hierarchical clustering ########

apply(species_cluster_data, 1, sum)

# convert the CPUE of each species from each event to the proportion of the total catch of
# that species in all events during all trips of the study (relativizing by species totals)

species_cluster_data <- decostand(species_cluster_data, method = "total")

# check total abundance in each sample

apply(species_cluster_data, 1, sum)

# calculate Bray-Curtis distance among species

species_dist <- vegdist(species_cluster_data, method = "bray")

# cluster communities using average-linkage algorithm
species_cluster <- hclust(species_dist, method = "average")

# plot cluster diagram
plot(species_cluster, ylab = "Bray-Curtis dissimilarity")


# adjusted cluster diagram 

species_dend <- as.dendrogram(hclust(species_dist, method = "average"))

plot(species_dend, ylab = "Bray-Curtis dissimilarity",
     main = "Cluster Dendrogram", horiz = TRUE)

cutree(species_dend, k=9)


#====================================
# indicator species analysis 
#====================================

#trip_km = kmeans(trip_cluster_data, centers=5)
#groupskm = trip_km$cluster
#groupskm


###### using area as groupings 

# filter event id and species CPUE

species_cluster_matrix <- catch_wide_log[,-c(1,3:15)]

cluster_groups <-  catch_wide_log[,c(2,9)]

# use event ID as row names 

species_cluster_matrix <- as.data.frame(species_cluster_matrix, 
                                        row.names = species_cluster_matrix$EVENT_ID)
species_cluster_matrix <- as.data.frame(species_cluster_matrix, 
                                        row.names = species_cluster_matrix$EVENT_ID)

species_cluster_matrix <- species_cluster_matrix[,-1]


indval_area <- multipatt(species_cluster_matrix, cluster_groups$AreaGrouping, 
                         control = how(nperm=999))

summary(indval_area, indvalcomp=TRUE)
# Component ‘A’ is the probability that the surveyed
# site belongs to the target site group given the fact that the species has
# been found. This conditional probability is called the specificity or positive
# predictive value of the species as indicator of the site group. (2) Component
#‘B’ is the probability of finding the species in sites belonging to the site group.
# This second conditional probability is called the fidelity or sensitivity of the
# species as indicator of the target site group.
#http://www2.uaem.mx/r-mirror/web/packages/indicspecies/vignettes/indicspeciesTutorial.pdf


summary(indval_area, alpha=1)
# By setting alpha = 1 we say
# we want to display the group to which each species is associated, regardless
# of whether the association significant or not.
# still gives 18 species so those species that occur in sites belonging to all groups
# cannot be statistically tested, because there is no external group for comparison
# 25-18=7 species associated with all sites

indval_area$sign
# species with the highest IndVal corresponded to the set of all sites 
# as indicated by the NAs in the p.value column : 
# Pacific herring 
# Walleye pollock
# Rex sole               
# Flathead sole            
# Spotted ratfish
# Pacific dover sole
# Eulachon 

### Indicator species analysis without site groups combinations

indval_single_area <- multipatt(species_cluster_matrix, cluster_groups$AreaGrouping, 
                         duleg= TRUE, control = how(nperm=999))

summary(indval_single_area)
summary(indval_single_area,indvalcomp=TRUE)

indval_single_area$sign
# only Spotted ratfish did not associate to a group

### Restricting the order of site groups combinations

# max 2 site combinations 

indval_2_area <- multipatt(species_cluster_matrix, cluster_groups$AreaGrouping, 
                           max.order = 2, control = how(nperm=999))

summary(indval_2_area,indvalcomp=TRUE)

# max 3 site combinations 

indval_3_area <- multipatt(species_cluster_matrix, cluster_groups$AreaGrouping, 
                           max.order = 3, control = how(nperm=999))

summary(indval_3_area,indvalcomp=TRUE)


# combining species 

species_comb = combinespecies(species_cluster_matrix, max.order = 2)$XC
 dim(species_comb)

indvalspcomb = multipatt(species_comb, cluster_groups$AreaGrouping, duleg = TRUE,
                          control = how(nperm=999))
summary(indvalspcomb, indvalcomp = TRUE)

```

Figure 6. NMDS plots of species with secondary temperature, depth axes 

```{r Figure6}
####### ordination ########

# The metaMDS function automatically transforms data and checks solution
# robustness

event_mds <- metaMDS(species_cluster_matrix, dist = "bray", trymax = 150, k=3,
                     maxit = 300)

# Assess goodness of ordination fit (stress plot)
stressplot(event_mds)


# colour plot north vs south

blank_mds<- ordiplot(event_mds, type = "n")
points(blank_mds, "sites", col = "blue", 
       select=catch_wide_log$MAJOR_STAT_AREA_CODE=="8", pch=3, cex=0.5)
points(blank_mds, "sites", col = "green", 
       select=catch_wide_log$MAJOR_STAT_AREA_CODE=="1", pch=3, cex=0.5)
text(blank_mds, "species", col = "black", cex=0.6)

ordiellipse(blank_mds, catch_wide_log$MAJOR_STAT_AREA_CODE, conf = 0.95, label = FALSE)

legend("topright", legend=c("North", "South"), title= "Area", pch=19, 
       col=c("blue", "green"))

# add temp and depth axes to the plot

plot(envfit(blank_mds, catch_wide_log[, 14:15]), cex = 0.75)


# colour plot by area with ellipse

blank_mds<- ordiplot(event_mds, type = "n")
points(blank_mds, "sites", col = "blue", 
       select=catch_wide_log$AreaGrouping=="A1", pch=3, cex=0.5)
points(blank_mds, "sites", col = "orange", 
       select=catch_wide_log$AreaGrouping=="A2", pch=3, cex=0.5)
points(blank_mds, "sites", col = "red", 
       select=catch_wide_log$AreaGrouping=="A3", pch=3, cex=0.5)
points(blank_mds, "sites", col = "green", 
       select=catch_wide_log$AreaGrouping=="A4", pch=3, cex=0.5)
text(blank_mds, "species", col = "black", cex=0.6)

ordiellipse(blank_mds, catch_wide_log$AreaGrouping, conf = 0.95, 
            label = FALSE, col = area_colours)
legend("topright", legend=c("A1", "A2", "A3", "A4"), title= "Area", pch=19, 
       col=area_colours)
# add temp and depth axes to the plot

plot(envfit(blank_mds, catch_wide_log[, 14:15]), cex = 0.75)




##### filter by area - A1 #####

# set plot window to display all 4 area graphs at the same time
par(mfrow=c(2,2))

a1_data <- catch_wide_log %>% filter(., AreaGrouping=="A1")
  
NMDS_a1 <- a1_data[,-c(1,3:15)]

# use event ID as row names 

NMDS_a1 <- as.data.frame(NMDS_a1, row.names = NMDS_a1$EVENT_ID)
NMDS_a1 <- as.data.frame(NMDS_a1, row.names = NMDS_a1$EVENT_ID)

NMDS_a1 <- NMDS_a1[,-1]

# The metaMDS function automatically transforms data and checks solution
# robustness

mds_a1 <- metaMDS(NMDS_a1, dist = "bray", trymax = 150, k=3,
                           maxit = 300)

# Assess goodness of ordination fit (stress plot)

#stressplot(mds_a1)

# layering the plot 

blank_mds_a1<- ordiplot(mds_a1, type = "n")
points(blank_mds_a1, "sites", col = "blue", 
       select=a1_data$SEASON=="Winter", pch=3, cex=0.5)
points(blank_mds_a1, "sites", col = "orange", 
       select=a1_data$SEASON=="Spring", pch=3, cex=0.5)
points(blank_mds_a1, "sites", col = "red", 
       select=a1_data$SEASON=="Summer", pch=3, cex=0.5)
points(blank_mds_a1, "sites", col = "green", 
       select=a1_data$SEASON=="Fall", pch=3, cex=0.5)
text(blank_mds_a1, "species", col = "black", cex=0.6)


ordiellipse(blank_mds_a1, a1_data$SEASON, 
            conf = 0.95, label = FALSE, col = season_colours)

legend("topright", legend=c("Winter", "Spring", "Summer", "Fall"), title= "Season", pch=19, 
       col=season_colours)
title(main = "A1")

# add temp and depth axis

plot(envfit(blank_mds_a1, a1_data[, 14:15]), cex = 0.75, col = "black")


##### filter by area - A2 #####

a2_data <- catch_wide_log %>% filter(., AreaGrouping=="A2")

NMDS_a2 <- a2_data[,-c(1,3:15)]

# use event ID as row names 

NMDS_a2 <- as.data.frame(NMDS_a2, row.names = NMDS_a2$EVENT_ID)
NMDS_a2 <- as.data.frame(NMDS_a2, row.names = NMDS_a2$EVENT_ID)

NMDS_a2 <- NMDS_a2[,-1]

# The metaMDS function automatically transforms data and checks solution
# robustness

mds_a2 <- metaMDS(NMDS_a2, dist = "bray", trymax = 150, k=3,
                  maxit = 300)

# Assess goodness of ordination fit (stress plot)

#stressplot(mds_a2)

# layering the plot 

blank_mds_a2<- ordiplot(mds_a2, type = "n")
points(blank_mds_a2, "sites", col = "blue", 
       select=a2_data$SEASON=="Winter", pch=3, cex=0.5)
points(blank_mds_a2, "sites", col = "orange", 
       select=a2_data$SEASON=="Spring", pch=3, cex=0.5)
points(blank_mds_a2, "sites", col = "red", 
       select=a2_data$SEASON=="Summer", pch=3, cex=0.5)
points(blank_mds_a2, "sites", col = "green", 
       select=a2_data$SEASON=="Fall", pch=3, cex=0.5)
text(blank_mds_a2, "species", col = "black", cex=0.6)


ordiellipse(blank_mds_a2, a2_data$SEASON, 
            conf = 0.95, label = FALSE, col = season_colours)

legend("topright", legend=c("Winter", "Spring", "Summer", "Fall"), title= "Season", pch=19, 
       col=season_colours)
title(main = "A2")

# add temp and depth axis

plot(envfit(blank_mds_a2, a2_data[, 14:15]), cex = 0.75, col = "black")


##### filter by area - A3 #####

a3_data <- catch_wide_log %>% filter(., AreaGrouping=="A3")

NMDS_a3 <- a3_data[,-c(1,3:15)]

# use event ID as row names 

NMDS_a3 <- as.data.frame(NMDS_a3, row.names = NMDS_a3$EVENT_ID)
NMDS_a3 <- as.data.frame(NMDS_a3, row.names = NMDS_a3$EVENT_ID)

NMDS_a3 <- NMDS_a3[,-1]

# The metaMDS function automatically transforms data and checks solution
# robustness

mds_a3 <- metaMDS(NMDS_a3, dist = "bray", trymax = 150, k=3,
                  maxit = 300)

# Assess goodness of ordination fit (stress plot)

#stressplot(mds_a3)

# layering the plot 

blank_mds_a3<- ordiplot(mds_a3, type = "n")
points(blank_mds_a3, "sites", col = "blue", 
       select=a3_data$SEASON=="Winter", pch=3, cex=0.5)
points(blank_mds_a3, "sites", col = "orange", 
       select=a3_data$SEASON=="Spring", pch=3, cex=0.5)
points(blank_mds_a3, "sites", col = "red", 
       select=a3_data$SEASON=="Summer", pch=3, cex=0.5)
points(blank_mds_a3, "sites", col = "green", 
       select=a3_data$SEASON=="Fall", pch=3, cex=0.5)
text(blank_mds_a3, "species", col = "black", cex=0.6)


ordiellipse(blank_mds_a3, a3_data$SEASON, 
            conf = 0.95, label = FALSE, col = season_colours)

legend("topright", legend=c("Winter", "Spring", "Summer", "Fall"), title= "Season", pch=19, 
       col=season_colours)
title(main = "A3")

# add temp and depth axis

plot(envfit(blank_mds_a3, a3_data[, 14:15]), cex = 0.75, col = "black")

##### filter by area - A4 #####

a4_data <- catch_wide_log %>% filter(., AreaGrouping=="A4")

NMDS_a4 <- a4_data[,-c(1,3:15)]

# use event ID as row names 

NMDS_a4 <- as.data.frame(NMDS_a4, row.names = NMDS_a4$EVENT_ID)
NMDS_a4 <- as.data.frame(NMDS_a4, row.names = NMDS_a4$EVENT_ID)

NMDS_a4 <- NMDS_a4[,-1]

# The metaMDS function automatically transforms data and checks solution
# robustness

mds_a4 <- metaMDS(NMDS_a4, dist = "bray", trymax = 150, k=3,
                  maxit = 300)

# Assess goodness of ordination fit (stress plot)

#stressplot(mds_a4)

# layering the plot 

blank_mds_a4<- ordiplot(mds_a4, type = "n")
points(blank_mds_a4, "sites", col = "blue", 
       select=a4_data$SEASON=="Winter", pch=3, cex=0.5)
points(blank_mds_a4, "sites", col = "orange", 
       select=a4_data$SEASON=="Spring", pch=3, cex=0.5)
points(blank_mds_a4, "sites", col = "red", 
       select=a4_data$SEASON=="Summer", pch=3, cex=0.5)
points(blank_mds_a4, "sites", col = "green", 
       select=a4_data$SEASON=="Fall", pch=3, cex=0.5)
text(blank_mds_a4, "species", col = "black", cex=0.6)


ordiellipse(blank_mds_a4, a4_data$SEASON, 
            conf = 0.95, label = FALSE, col = season_colours)

legend("topright", legend=c("Winter", "Spring", "Summer", "Fall"), 
       title= "Season", pch=19,col=season_colours)
title(main = "A4")

# add temp and depth axis

plot(envfit(blank_mds_a4, a4_data[, 14:15]), cex = 0.75, col = "black")

par(mfrow=c(1,1))

#==============================================================
# Figure 7. Maps of showing cluster locations by month
#==============================================================

# A1 - no results 

B=strassoc(species_cluster_matrix, cluster=cluster_groups$AreaGrouping ,func="B")
 sel=which(B[,"A1"]>0.2)
 sel

 sc= indicators(X=species_cluster_matrix[,sel], 
                cluster=cluster_groups$AreaGrouping, group="A1", verbose=TRUE,
                 At=0.5, Bt=0.2)
 
 print(sc, sqrtIVt = 0.6)
 
 # A2 - no results 
 
 B=strassoc(species_cluster_matrix, cluster=cluster_groups$AreaGrouping ,func="B")
 sel=which(B[,"A2"]>0.2)
 sel
 
 sc= indicators(X=species_cluster_matrix[,sel], 
                cluster=cluster_groups$AreaGrouping, group="A2", verbose=TRUE,
                At=0.5, Bt=0.2)
 
 print(sc, sqrtIVt = 0.6)
 
 
 # A3 - Spotted ratfish, Slender soles, North pacific hake, Sidestripe shrimp

 B=strassoc(species_cluster_matrix, cluster=cluster_groups$AreaGrouping ,func="B")
 sel=which(B[,"A3"]>0.2)
 sel
 
 sc= indicators(X=species_cluster_matrix[,sel], 
                cluster=cluster_groups$AreaGrouping, group="A3", verbose=TRUE,
                At=0.5, Bt=0.2)
 
 print(sc, sqrtIVt = 0.8)

 
 # A4
 
 B=strassoc(species_cluster_matrix, cluster=cluster_groups$AreaGrouping ,func="B")
 sel=which(B[,"A4"]>0.2)
 sel
 
 sc= indicators(X=species_cluster_matrix[,sel], 
                cluster=cluster_groups$AreaGrouping, group="A4", verbose=TRUE,
                At=0.5, Bt=0.2)
 
 print(sc, sqrtIVt = 0.8)
 
```

To identify community similarity among months and areas a series of correlation analyses that compared catch composition and multivariate analyses of catch data were used. These analyses were conducted on the 25 most abundant species and taxonomic groupings in the catch (measured by total CPUE across all study areas and months). Pairwise correlations among species CPUE were computed and compared to identify potential patterns in co-occurrence of species in the catches. There were highly skewed distributions in these catch data sets, so a log transformation was used to best meet normality assumptions. Because of the presence of zero catches for some species in some trawl hauls we added a small constant value (1/2 of the smallest positive catch for the species) to the CPUE data prior to transformation. Other constants were tested in exploratory analyses, such as adding 1 or 10% of the mean value, but ½ of the minimum positive catch produced the most normal distribution across the wide variety of species. Cluster analysis based on Bray-Curtis dissimilarity matrices were used to compare month and area combinations of catches. Two clustering methods, hierarchical cluster analysis with Ward's minimum variance method (Murtagh and Legendre 2014) and a non-hierarchical method, k-means clustering (Borcard et al. 2018) were used. In the k-means optimization of the Ward's classification, the mean taxa values for each of the clusters from the Ward's classification were used as a starting point for the k-means optimization and the sum of the squared Euclidean distances within the groups was minimized. Dendrograms based on the Bray-Curtis dissimilarity were used to identify similar patterns in catch composition among areas and months. In the hierarchical cluster analysis, we determined the number of clusters based on silhouette width (a measure of how well a site is clustered) and species fidelity analysis (a measure of how well a cluster is characterized by a set of indicator species) (Borcard et al. 2018). The silhouette width is based on the average dissimilarity between a site and all sites of the cluster to which it belongs, compared to the same measure computed for the next closest cluster; silhouette widths range from -1 to 1 (Borcard et al. 2018). The optimal number of clusters is the number which maximizes the average silhouette width. Species fidelity analysis is based on the concepts of specificity (highest when the species is present in the target group but not elsewhere) and fidelity (highest when the species is present in all sites of the target group). We applied the Dufrêne and Legendre (1997) IndVal index available in the R package 'labdsv', which is a function of specificity and fidelity. The optimal number of clusters is the number which maximizes the IndVal index. Non-metric dimensional scaling was also applied to the data. For NMDS, we tested second and fourth root transformations (Clarke 1993) and chose fourth root based on the stress value, NMDS convergence and NMDS axes plot. Cluster membership was tested using analysis of similarity (ANOSIM) and discriminant function analysis (DFA). For ANOSIM and DFA, the catch data were log (+ constant) transformed prior to analysis. The constant used for each species was one-half of the minimum positive catch (CPUE \> 0) for that species. All analyses were conducted using R software (R Core Team 2019) and significance for all tests was judged at p \< 0.05. We used canonical correspondence analysis (CCA) (ter Braak 1986) to identify the primary environmental variables structuring deep-sea coral and sponge assemblages in Alaska (Table 2). Our CCA compared the deep-sea coral and sponge data (12 taxa, Table 1) to the nine environmental variables. In this sense, the deep-sea coral and sponge data set is the response matrix and the environmental data set is the explanatory matrix. The CCA was conducted using the 'vegan' package in R. The use of CCA should be limited to situations where rare species are well sampled and are seen as potential indicators of particular characteristics of an ecosystem (Borcard et al. 2018). In our data set, only one taxon was rare (FO \< 0.01, Table 1) and taxa were well sampled with the data set consisting of over 850 transect locations. The taxa data are the raw, untransformed abundances in CCA. CCA results were tested by permutation, which combined with a variable selection process (the 'ordistep' function in the 'vegan' package), was used to find the most parsimonious relationships between the environmental and deep-sea coral and sponge data sets. We displayed the relationships in a biplot. In the biplot, arrows for related environmental variables point in the same general direction, representing a gradient from low values (arrow base) to high values (arrow point). Taxa are located in the biplot along the environmental gradient at their mean position weighted by abundance, so taxa occurring near the point of a variable arrow are positively influenced (more abundant) by that environmental variable.

### Indicator species analysis

Indicator species for each of the resolved clusters was also determined using multilevel pattern analysis (REFERENCE).

# Results

Two hundred and four individual taxonomic groups were identified from survey catches across the four areas and 16 months of surveys (Supplemental Material 1). These included 89 species, 8 families and 2 genus of fishes and 69 species, 12 genus and 10 families, 1 superfamily, 2 orders, 1 suborder, 5 classes, 1 subphylum, and 4 phyla of invertebrates. Fishes were dominant by biomass, comprising 90% of the total CPUE. However, the top 25 species captured across regions included 6 invertebrate groups (Table 1). The top 25 species comprised 97.4% of the mean CPUE across the regions and were dominated throughout all months by spotted ratfish (Hydrolagus colliei) and walleye pollock (Gadus chalcogrammus) which together comprised greater than 50% of the CPUE in most month-area combinations (Figure 2). 
In general, the species were not strongly correlated to each other (Figure 3). The strongest positive correlations were among the shrimp species, eelpout species and a few other fishes (slender sole, flathead sole and eulachon). Negative correlations tended to be strongest between the larger bodied fish species (e.g. hake, the skate species, Pacific cod and spiny dogfish) and shrimp species (Figure 3). The most abundant species, spotted ratfish had low correlations with all species, perhaps reflecting the ubiquitous nature of the species throughout the study area.

There were significant differences among seasons and areas in terms of diversity of the catch. Species evenness measured by the Pielou's evenness index showed lower diversity in the winter compared to other seasons (Figure 4), but the difference was only significant between fall and winter. The only significant difference among areas was the higher evenness at Chatham Sound sites compared to Haro Strait sites (Figure 4). Chatham sound also had higher evenness than the other two areas, although not significant. For Simpsons diversity index both area and season were significant, but not the interaction term. The Strait of Georgia had a higher diversity than the other areas, but not significantly higher than any of the other areas (Figure 4). The post-hoc tests revealed a significant difference between Chatham Sound and the Strait of Georgia, but no significant differences in the individual seasons were detected. Species richness was the only diversity measure where a significant area and season interaction term was found to be significant (Figure 4). Species richness in the spring was lower than the other seasons, while fall richness was the highest. Species richness was lower in the Strait of Juan de Fuca than in all other areas (Figure 4). There were some significant differences detected by the post-hoc tests among season and area combinations, but there were no consistent patterns, except that the number of species captured in the winter in Haro Strait and the Strait of Georgia were the highest and the Strait of Juan de Fuca the lowest in winter, spring and summer (Figure 4). Cluster analysis clearly showed that the regional differences in community assemblages were stronger than seasonal differences (Figure 6). With the exception of October 2017 in the Haro Strait area which was similar to the same time period in the Strait of Georgia, each of the months of sampling were more similar to other months in the same area, than the same month in different areas.

# Discussion

# Acknowledgments

# References

<div id="refs"></div>

<!-- Required for proper indentation in following sections -->
\setlength{\parindent}{0in} 
\setlength{\leftskip}{0in} 
\setlength{\parskip}{4pt}


# Tables

```{r ft.align="left",echo=FALSE,message=FALSE,warning=FALSE}


ft <- flextable(samples_wide)
ft <- set_caption(ft, "Number of bottom trawl hauls conducted by season, area and year using the small mesh bottom trawl in 2017-2019.", 
  autonum = run_autonum(seq_id = "tab", bkm = "Table1"))
ft
#kableExtra::kable_styling(font_size = 8) %>%
#              add_header_above(c(" "=3,"Region"=6), bold=TRUE)# %>%
  
#kableExtra::footnote(alphabet = 
#c("16 quadrats also identified in the data", "24 quadrats also identified in the data", "Quadrat counts in the data were all $\\\\geq$ 32", "32 quadrats also identified in the data", "8 quadrats also identified in the data", "Survey plan consisted of priority levels assigned to sites (if no Northern Abalone were found in the first 8 quadrats, surveying was stopped in low priority sites but continued in high priority sites)"), threeparttable = TRUE, general_title = "",escape = FALSE)
                
            #Note: do not break footnote over more than one line or returns "makecell[l]" at start of footnote

```

```{r ft.align="left",echo=FALSE,message=FALSE,warning=FALSE}

ft <- flextable(mean_CPUE_top25_area)
ft <- set_caption(ft, "Mean catch-per-unit effort by area for the top 25 species captured using the small mesh bottom trawl in 2017-2019.",   autonum = run_autonum(seq_id = "tab", bkm = "Table2"))
ft

```
mean_CPUE_top25_area

# Figures

```{r Figure1, fig.cap="Locations of bottom trawls carried out in each of the four study regions during 2017-2018.", echo=FALSE, fig.pos="h",message=FALSE,warning=FALSE}

knitr::include_graphics("C:/Users/rooperc/Desktop/Eulachon/EulachonMultivariateAnalysis/Manuscript/Figure1.png")

```

```{r Figure2, fig.cap="Proportion of catch for top species in stacked bar graphs by month and area. Average CPUE by month and area for the top 25 species across all samples.", echo=FALSE, fig.pos="h",message=FALSE,warning=FALSE}

knitr::include_graphics("C:/Users/rooperc/Desktop/Eulachon/EulachonMultivariateAnalysis/Manuscript/Figure2.png")

```

```{r Figure3, fig.cap="Correlation plot among species for co-occurrence in the trawl hauls.", echo=FALSE, fig.pos="h",message=FALSE,warning=FALSE}

knitr::include_graphics("C:/Users/rooperc/Desktop/Eulachon/EulachonMultivariateAnalysis/Manuscript/Figure2.png")

```

```{r Figure4, fig.cap="Species diversity measures for catches of species in the bottom trawl hauls of four regions of nearshore British Columbia by season from 2017-2019.", echo=FALSE, fig.pos="h",message=FALSE,warning=FALSE}

knitr::include_graphics("C:/Users/rooperc/Desktop/Eulachon/EulachonMultivariateAnalysis/Manuscript/Figure4.png")

```
